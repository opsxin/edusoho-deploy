version: "3"

services:
  init:
    image: busybox
    container_name: download-edusoho
    command:
      - "sh"
      - "-c"
      - "if [ ! -d /data/edusoho -a ! -f /data/edusoho.zip ]; then cd /data && wget http://download.edusoho.com/edusoho-8.7.15.zip -O edusoho.zip && unzip edusoho.zip && chown www-data:www-data -R /data/edusoho; fi"
    volumes:
      - web:/data
    restart: "no"
  db:
    image: mysql:5.7
    container_name: edusoho-db
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: $DB_ROOT_PASSWORD
      MYSQL_DATABASE: $DB_NAME
      MYSQL_USER: $DB_USER
      MYSQL_PASSWORD: $DB_PASSWORD
    volumes:
      - db:/var/lib/mysql
    restart: always
  fpm:
    build:
      context: .
      dockerfile: php/Dockerfile
    container_name: edusoho-php
    volumes:
      - web:/var/www
    depends_on:
      - init
    restart: always
  nginx:
    build:
      context: .
      dockerfile: nginx/Dockerfile
    container_name: edusoho-nginx
    depends_on:
      - init
      - fpm
      - db
    volumes:
      - web:/var/www
    ports:
      - 80:80
    restart: always

volumes:
  web:
  db:
